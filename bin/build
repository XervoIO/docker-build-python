#!/usr/bin/env bash
set -e
set -x # TODO remove

if [[ ! $INPUT_DIR ]] || [[ ! $OUTPUT_DIR ]]; then
  echo "Input/Output directory variables must be set.\n"
  exit 1
fi

cp -R /opt/pyenv/. /mnt/home/pyenv

export PATH=$PYENV_ROOT/bin:$PATH

eval "$(pyenv init -)"
eval "$(pyenv virtualenv-init -)"

cd $INPUT_DIR

VERSION=2.7.10

# if no .python-version file exists, create one
if [[ ! -f $INPUT_DIR/.python-version ]]; then
  # inherit version from app.json
  if [[ $MODULUS_CONFIG_ENGINES_PYTHON ]]; then
    VERSION=$MODULUS_CONFIG_ENGINES_PYTHON
  fi
  pyenv install -s $VERSION
  pyenv local $VERSION
fi

pyenv install -s
pyenv virtualenv app
pyenv activate app

PIP_FLAGS="--exists-action=w --disable-pip-version-check --no-cache-dir"
# install requirements and package
pip install -r requirements.txt $PIP_FLAGS

# install gunicorn
pip install gunicorn $PIP_FLAGS


mkdir -p $OUTPUT_DIR/.modulus

# copy /opt/pyenv to $OUTPUT_DIR/.modulus/opt/pyenv
cp -R $INPUT_DIR/. $OUTPUT_DIR
cp -R $PYENV_ROOT/. $OUTPUT_DIR/.modulus/pyenv
