#!/usr/bin/env bash
set -e
set -x # TODO remove

if [[ ! $INPUT_DIR ]] || [[ ! $OUTPUT_DIR ]]; then
  echo "Input/Output directory variables must be set.\n"
  exit 1
fi

cp -R /opt/pyenv/. /mnt/home/pyenv

export PATH=$PYENV_ROOT/bin:$PATH

eval "$(pyenv init -)"
eval "$(pyenv virtualenv-init -)"

cd $INPUT_DIR

# determine python version
pyenv install -s
pyenv virtualenv app
pyenv activate app

# install requirements and package
pip install -r requirements.txt --exists-action=w --disable-pip-version-check --no-cache-dir

mkdir -p $OUTPUT_DIR/.modulus

# copy /opt/pyenv to $OUTPUT_DIR/.modulus/opt/pyenv
cp -R $INPUT_DIR/. $OUTPUT_DIR
cp -R $PYENV_ROOT/. $OUTPUT_DIR/.modulus/pyenv
